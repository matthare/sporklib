#!/usr/bin/env python
from lxml import etree
import isbn

url_base = 'http://techbus.safaribooksonline.com/xmlapi/?id='

crazy_aliases = ['9780596518561', '9781565924642', '9781606492147', '9780596101435', '9780596007126', '9780596527761', '9780596529277', '9780596003135', '9781593274146', '9780596002459', '9781565923911', '9781565922259', '9780596000356', '9781606491300', '9781606493199', '9780596002398', '9780596155285', '9780596527501', '9780596000172', '9781565927018', '9781609604875', '9781565927445', '9781606491867', '9780596004538', '9780596004477', '9781565926165', '9780596101442', '9781593270650', '9781606491232', '9780596003555', '9780596100520', '9780596001674', '9780596008987', '9780596527945', '9780596002176', '9781606494066', '9780596004194', '70004LTI24205', '9781606491423', '9781904811022', '9783866453166', '9780596003814', '9780596004606', '9780596002817', '9780596006099', '9780596002350', '9780596005634', '9780596005221', '9780596001605', '9780596002497', '9780596004583', '9780596004996', '9780596006075', '9781606491645', '9781565927193', '9781565924499', '9781565924789', '9781606493410', '9780596001032', '9781565927469', '9781565924697', '70004LTI74965', '9781565929418', '9781606492369', '9780596004699', '9780596006471', '9780596002787', '9780596001773', '9780596000301', '9780596006204', '9780596001254', '9780596001520', '9781606492109', '9780596527723', '9780596002602', '9780596003173', '9781565927681', '9780596000783', '9780596528133', '9780596008185', '9781565924321', '9780596527396', '9781565927049', '9780596000608', '9781565923775', '9781606493090', '9781565923478', '9780596008383', '9780596001322', '9781606493687', '9780596006853', '9780596007676', '9780596008543', '9780596007010', '9781606492345', '9780596003517', '9780596000738', '9781593271053', '9780596003784', '70004LTI73920', '70004LTI73922', '9781565923256', '9780596100544', '9780596100469', '9781565925298', '9781606491461', '9780596003999', '9780596009373', '9780596004255', '9780596000127', '9780596005382', '9780596006587', '9781606491096', '9780596007829', '9781606494479', '9780596005573', '9780596006754', '9780596007218', '9780596510312', '9781609608842', '9781565927698', '9781606491683', '9780596007522', '9780596100827', '9781565927094', '9780596009533', '9781565923539', '9781606492321', '9780596527327', '9780596005832', '9780596005627', '9780596003722', '9780596006785', '9780596006105', '9780596102074', '9780596005436', '9780596005702', '9780596005252', '9781606492246', '9781606492796', '9781606493700', '9781565925779', '9780596006242', '9780596006327', '9781593271855', '9781593272890', '9780596006976', '9780596002725', '9780596518387', '9780596100643', '9780596003708', '70004LTI61391', '9781606493823', '9780987153081', '9780596004811', '70004LTI35096', '9780596003098', '9780596526757', '9780596001438', '9781565924550', '9780596003883', '9780596006815', '9780596009786', '9780596001162', '9781565926271', '9780596527068', '9781565926653', '9780596003388', '9780596527266', '9780596004040', '9780596001797', '9781606491706', '9781565925250', '073561637', '9780596004385', '9780596002268', '9781565924666', '9780596529918', '9780596002008', '9780596000165', '073562044', '9780596100155', '9780596005139', '9781565924031', '9780596529628', '9780596008574', '9780596102401', '9780596001193', '9780596007140', '9781565926615', '9780596000646', '9780596003609', '9780596000189', '9781593272579', '9781565921047', '9781606493519', '9780596002169', '9780596002619', '9780596009779', '9781565928381', '9780596006006', '9780596007065', '9780596100322', '9780596007751', '9781606493175', '9781606493076', '9781609607944', '9780596006662', '9780596007249', '9781606493748', '9780596004828', '9781565926103', '9780596510220', '9781457165955', '9780596007553', '9780596002435', '9781565925106', '9780596527846', '9780596002763', '9781606493212', '9781606491072', '9781606491485', '9781606492468', '9780596004507', '9780596528065', '9780596001889', '9781606492505', '9780596005368', '9780596002046', '9781606492659', '9780596004668', '9780133034486', '9780596003081', '9781565924345', '9780596006211', '70004LTI61335', '9780596002909', '9780596009090', '9781606493885', '9780596003593', '9780596527037', '9780596008628', '9781904811855', '9781565922068', '9781565927131', '9780596009656', '9780596001704', '9780596004002', '9781565928398', '9780596527228', '9780596101190', '9780735639850', '9780596004590', '9781565922204', '9780596000486', '9780596000202', '9781565924505', '9780596000929', '9781606492123', '9781606492000', '9780596009878', '9780596001230', '9781593270032', '9780596009007', '9780596003524', '9780596003289', '9780596101992', '9781565923249', '9781565927148', '9781593272838', '9780596003449', '9780596000158', '9781565925366', '9780596002534', '9780596002138', '70004LTI74805', '9781565928435', '9781565923065', '9781606490136', '9780596000059', '9781606493786', '9781606491966', '9780596000271', '9781904811404', '9781606491218', '9781565927056', '9780596006150', '9780596101497', '9781593272043', '9780596003234', '9780596527969', '9780596101732', '9780596001292', '9781606491133', '9780596003623', '9780596003838', '9780596008222', '9781565924895', '9780596007928', '9780596528270', '70004LTI74111', '9781565923850', '9780596006488', '9780596005894', '9781606491584', '9781565925786', '9780596001575', '9780596001971', '9781565926004', '9780596528188', '9780596003494', '9780596002657', '9780596101015', '9780596003302', '0321434536', '9781565929470', '9781617290091', '9781565926479', '9781565924000', '9780596006556', '9781565924949', '9780596102111', '9780596102098', '9780596000714', '70004LTI74700', '9780596005023', '073562206', '9780596001179', '9780596001278', '9780596000936', '9780596003159', '9781565928718', '9780596002978', '9780596527075', '9781606494264', '9780596003012', '9780596003692', '9781606494950', '9780596008765', '9780596001285', '9780596003395', '9780596002374', '9780596005856', '9781565926912', '9781565922921', '9781606490853', '9780596000257', '9780596001308', '9780814431931', '9780596005115', '9783868999112', '9780596008406', '9780596008567', '9780596009625', '9780596527631', '9780596007157', '9780596002305', '9780596007096', '9780596003579', '9780596100681', '9780596001650', '9780596002114', '9781606492772', '9780596006686', '9781606492697', '9781565926820', '9781565927209', '9780596003876', '9780596008451', '9781606492581', '9781565926981', '9781606493809', '9781565928565', '9780596527556', '9780596001186', '9780596001957', '9780596001841', '9780596002572', '9780596007379', '9780596005597', '9780596002695', '9780596001001', '9780596002756', '9781565924192', '9780596004088', '9780596001896', '9781565928404', '9780596101053', '9781565929432', '9781606492420', '9781606492307', '9780596526726', '9780596000080', '9780735625488', '9780596004903', '9780596006518', '9780596002053', '9781606492673', '9780596000998', '9781565928695', '9780596000448', '9780596004880', '9780596008635', '9780596529789', '9780596005276', '9781606491034', '9780987247858', '9781593270469', '9780596100667', '9781565927537', '9780596000844', '9780596001339', '9780596009830', '9780596002411', '073561931', '9780596000530', '9781606492406', '9780596004873', '70004LTI22873', '9780596101978', '9781606491805', '9780596101428', '9780596000882', '9780596007287', '9780596003531', '9780596527334', '9781565926707', '9780596006365', '9781565923904', '9780596003432', '9780596009182', '9780596004705', '9781565926097', '9780596007102', '9780596007737', '9780596009427', '9781606491720', '9780470384206', '073562187', '9780596009250', '9780596519230', '9781565928527', '9781606494042', '9780596006631', '9781565926875', '9780596005559', '073562061', '9781606493656', '9781606491560', '9780596005658', '9780596007607', '9780596807641', '9780596008956', '9780596003821', '9781565921528', '9780071601276', '9780596009137', '9781565924154', '9781449394837', '9780596004644', '9781606491027', '9780596527341', '9781606491386', '9780596528263', '9781565925007', '9780596004200', '9780596527464', '9781606493113', '9780596001711', '9780596001964', '70004LTI65953', '9780596527419', '9780596001612', '9781565925373', '9781606493311', '9780596005641', '9780596006068', '9780596005900', '9780596008772', '9781466619548', '9780596006990', '9780596003487', '9780596009601', '9781565922693', '9780596009748', '9781565927186', '9780596004118', '9780596100582', '9781565922433', '9780596000967', '9780596154868', '9783897216631', '9781606492529', '9781565925151', '9781904811688', '9780596005429', '9781565926813', '078973611X', '9780596008482', '9780596006174', '9781606491171', '9781565922822', '9780596001452', '9780596002961', '9780596002848', '9781565926424', '9781565928701', '9780596527082', '9780596528126', '9781565924574', '9781118016183', '9780596004729', '9780596527471', '9780596003364', '9780596000400', '9780596001810', '70004LTI74803', '9780596002367', '9780596005283', '9780987247872', '9780596154639', '9781565925793', '9780596008413', '9781565923799', '9781565922891', '9780596005306', '9780596527600', '9781606492185', '9780596007645', '9781606493557', '9781606493618', '70004LTI74374', '9781565926226', '9780596007164', '9780596003463', '9780596006693', '9780596007461', '9781606493847', '9781606492383', '9780596000790', '9780596100575', '9781565922860', '9781606492932', '9781565924857', '9780596009205', '9781565928411', '9780596100346', '9780596005764', '9781606491942', '9780596006945', '9780596009168', '9780596000417', '9780596002565', '9780596006761', '9781565925984', '9780596003210', '9781565920545', '9780596008734', '9780596002039', '9781565925168', '9781565924185', '9780596528096', '9781606491058', '9780596003760', '9780596003913', '9780596004569', '9780596007614', '9781565929425', '9780596006266', '9780596007942', '9780596007584', '9780596004392', '9781904811800', '9780596005269', '9780596100292', '9780071549271', '9780596001728', '073562271', '9780596000455', '9780596000981', '9780596001100', '9780596004897', '9781606492208', '9780596101787', '9780596004781', '9780596004026', '9780596000851', '9780596004415', '9780596529956', '9780596006433', '70004LTI61388']

mapped = 0
total = 0
f = open('/home/mhare/fpid.map', 'w')
for alias in crazy_aliases:
    total += 1
    if not isbn.valid(alias):
        print "invalid isbn " + alias
    else:
        
        alias13 = ''
        fpid_str13 = ''
        if len(alias) == 13:
            alias13 = isbn.convert(alias)
            url = url_base + alias13
            bvd_goo = etree.parse(url)
            fpid = bvd_goo.xpath('/safari/book/@id')
            if fpid != []:
                fpid_str13 = str(fpid).replace("['","").replace("']","")
                
        fpid_str = ''
        url = url_base + alias
        bvd_goo = etree.parse(url)
        fpid = bvd_goo.xpath('/safari/book/@id')
        if fpid != []:
            fpid_str = str(fpid).replace("['","").replace("']","")

        output = ''
        if fpid_str and not fpid_str13:
            #print "A " + alias + " -> " + fpid_str
            output = alias + "," + fpid_str + "\n"
        elif fpid_str13 and not fpid_str:
            #print "B " + alias + " -> " + alias13 + " -> " + fpid_str13
            output = alias + "," + fpid_str13 + "\n"
        elif fpid_str and fpid_str13:
            if fpid_str == fpid_str13:
                #print "A " + alias + " -> " + fpid_str
                output = alias + "," + fpid_str + "\n"
            else:
                print "ERROR: inconsistent ISBN conversion " + alias
        else:
            print "A " + alias + " -> " + "NONE"
        if output:
            mapped += 1
            f.write(output)
                
f.close()
notmapped = total - mapped
print total
print mapped
print notmapped
